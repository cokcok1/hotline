<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–ç¶“ç ”è®€ / Bible Study (V2 - Auto Mode)</title>

    <link rel="apple-touch-icon" sizes="180x180" href="bible-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="bible-icon.png">
    <link rel="icon" type="image/png" href="bible-icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --bg: #f0f2f5; 
            --text: #333333;
            --primary: #2c3e50;
            --accent: #8e44ad;
            
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            
            --input-bg: #ffffff;
            --input-border: #cccccc;
            --input-text: #333333;
            --nav-btn-bg: #ffffff;
            --nav-btn-color: #95a5a6;
            
            --scripture-size: 1.25rem;
            --highlight-color: #f1c40f55;
            --gemini-title-border: #f39c12;

            --element-height: 52px;
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --text: #e2e8f0;
            --primary: #60a5fa;
            --accent: #a78bfa;
            --glass-bg: rgba(30, 41, 59, 0.85); 
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            --input-bg: #1e293b;
            --input-border: #475569;
            --input-text: #ffffff;
            --nav-btn-bg: #1e293b;
            --nav-btn-color: #94a3b8;
            --highlight-color: #d9770688;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
            padding-bottom: 120px;
            -webkit-text-size-adjust: 100%;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container { max-width: 800px; margin: 0 auto; }
        
        h1 { text-align: center; color: var(--primary); font-size: 1.5rem; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #888; font-size: 0.9rem; margin-bottom: 15px; }

        .loading-container { text-align: center; margin: 10px 0 20px 0; }
        .progress-bar { width: 100%; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .controls-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            opacity: 0.5; pointer-events: none; transition: opacity 0.3s;
        }
        .controls-grid.active { opacity: 1; pointer-events: all; }
        
        .full-width { grid-column: 1 / -1; }
        .verse-group { display: flex; align-items: center; gap: 5px; grid-column: 1 / -1; }
        
        select {
            height: var(--element-height); padding: 0 12px;
            border: 1px solid var(--input-border); border-radius: 8px;
            font-size: 16px; width: 100%; 
            background: var(--input-bg); color: var(--input-text); box-sizing: border-box;
        }

        .nav-row { grid-column: 1 / -1; display: flex; gap: 10px; margin-top: 5px; }
        
        .read-btn, .nav-btn, .ai-btn {
            height: var(--element-height); box-sizing: border-box;
            display: flex; align-items: center; justify-content: center;
        }

        .read-btn {
            flex-grow: 2; background-color: var(--primary); color: white; border: none;
            border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
        }
        .nav-btn {
            flex-grow: 0; min-width: 60px;
            background-color: var(--nav-btn-color); color: white; border: none;
            border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer;
        }

        .scripture-card {
            background: var(--glass-bg); padding: 25px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
            display: none; 
            border-left: 5px solid var(--accent);
            position: relative;
        }

        /* V2 ä¿®æ”¹ï¼šAction Area æ”¹ç‚ºå–®ä¸€å…¨å¯¬ */
        .action-area { 
            display: block; width: 100%; margin-bottom: 20px; 
        }
        
        .glass-btn {
            width: 100%; padding: 5px; border-radius: 10px; border: none;
            color: white; font-weight: 600; font-size: 0.95rem;
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            white-space: normal; line-height: 1.2; text-align: center;
            height: 50px; /* ç¨å¾®åŠ é«˜ */
        }
        .ai-btn { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); }

        .ref-title {
            font-size: 1.3rem; font-weight: bold; color: var(--accent);
            margin-bottom: 15px; border-bottom: 2px solid rgba(128,128,128,0.2); padding-bottom: 10px;
        }
        .scripture-text {
            font-size: var(--scripture-size); 
            line-height: 1.8; white-space: pre-wrap; color: var(--text);
            margin-bottom: 20px;
        }
        .verse-num { color: #888; font-weight: normal; font-size: 0.8em; margin-right: 4px; }

        .context-btn {
            width: 100%; margin-top: 10px; margin-bottom: 20px; border-radius: 10px; border: none;
            color: white; font-weight: bold; font-size: 1rem; cursor: pointer;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
            display: none; height: var(--element-height);
        }

        /* Gemini å€å¡Š */
        .gemini-section {
            display: none; 
            background: var(--glass-bg);
            padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 1px solid var(--glass-border); 
            margin-top: 20px; color: var(--text);
        }
        .gemini-header {
            display: flex; align-items: center; gap: 10px;
            font-size: 1.2rem; font-weight: bold; color: var(--text);
            margin-bottom: 10px; border-bottom: 2px solid var(--gemini-title-border); padding-bottom: 10px;
        }
        .gemini-content { font-size: 1.05rem; line-height: 1.7; color: var(--text); opacity: 0.9; }
        .gemini-content h1, .gemini-content h2, .gemini-content h3 { 
            color: var(--primary); margin-top: 15px; margin-bottom: 8px; font-size: 1.1em; 
        }
        .gemini-content p { margin-bottom: 10px; }
        .gemini-content strong { color: #e74c3c; } 
        
        .ai-loading { text-align: center; padding: 20px; font-style: italic; color: #888; display: none; }
        .ai-spinner {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(128,128,128,0.2); border-top: 3px solid var(--gemini-title-border);
            border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .footer-note {
            text-align: right; font-size: 0.75rem; color: #888;
            border-top: 1px solid rgba(128,128,128,0.1); padding-top: 10px; font-style: italic;
        }

        /* éš±è—éƒ¨åˆ† V31 å…ƒç´ ä»¥ç°¡åŒ–ä»‹é¢ */
        .lang-switch-row, #toolsRow, #sourceLabel { display: none; }
        
        @media (max-width: 600px) { 
            .controls-grid { grid-template-columns: 1fr; } 
        }
    </style>
</head>
<body>

<div class="container">
    <div class="glass-card main-control-card">
        <h1 id="appTitle">ğŸ“– è–ç¶“æ€¥æ•‘ç ”è®€ (V2)</h1>
        
        <div id="loadingArea" class="loading-container">
            <div id="loadingText">æ­£åœ¨ä¸‹è¼‰è³‡æ–™åº«...</div>
            <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        </div>

        <div id="controlGrid" class="controls-grid">
            <select id="bookSelect" class="full-width" onchange="updateChapters()"><option>è¼‰å…¥ä¸­...</option></select>
            <select id="chapterSelect" class="full-width" onchange="updateStartVerses()"><option>-</option></select>
            
            <div class="verse-group">
                <select id="startVerseSelect" class="full-width" onchange="updateEndVerses()"><option>-</option></select>
                <span id="toLabel" style="display:none; padding: 0 5px;">è‡³</span>
                <select id="endVerseSelect" class="full-width" style="display:none;"><option>-</option></select>
            </div>

            <div class="nav-row">
                <button class="nav-btn" id="prevBtn" onclick="prevChapter()" title="ä¸Šä¸€ç« ">â®</button>
                <button class="read-btn" id="readBtn" onclick="displayScripture()">é–±è®€ç¶“æ–‡</button>
                <button class="nav-btn" id="nextBtn" onclick="nextChapter()" title="ä¸‹ä¸€ç« ">â¯</button>
            </div>
        </div>
    </div>

    <div id="resultCard" class="scripture-card">
        
        <div id="actionArea" class="action-area">
            <button class="glass-btn ai-btn" id="geminiBtn" onclick="callGeminiAPI()">âœ¨ Gemini æ™ºèƒ½è§£ç¶“</button>
        </div>

        <div class="ref-title" id="displayRef"></div>
        <div class="scripture-text" id="displayText"></div>

        <button id="contextBtn" class="context-btn" onclick="switchToWholeChapter()">ğŸ“– é–±è®€æ•´ç«  (é¡¯ç¤ºä¸Šä¸‹æ–‡)</button>

        <div id="geminiSection" class="gemini-section">
            <div class="gemini-header">
                <span id="geminiHeader">ğŸ¤– Gemini è§£è®€</span>
            </div>
            <div id="aiLoading" class="ai-loading">
                <div class="ai-spinner"></div> <span id="loadingMsg">æ­£åœ¨é€£ç·š Google Gemini...</span>
            </div>
            <div id="geminiResult" class="gemini-content"></div>
        </div>

        <div class="footer-note" id="footerVer">Powered by Google Gemini AI. 2026-01-03 (V2 Auto)</div>
    </div>
</div>

<textarea id="hiddenPrompt" style="display:none;"></textarea>

<script>
    const GEMINI_API_URL = 'https://little-thunder-4b7b.imsklam1.workers.dev';
    const BIBLE_URL_ZH = 'https://cokcok1.github.io/bible-ai/chinese_union_trad_trad.txt';
    
    let bibleData = {};
    let bookOrder = [];

    window.onload = function() {
        loadBibleData(BIBLE_URL_ZH);
    };

    async function loadBibleData(url) {
        try {
            bibleData = {};
            bookOrder = [];
            
            const response = await fetch(url);
            if (!response.ok) throw new Error("Network Error");
            
            const reader = response.body.getReader();
            const contentLength = +response.headers.get('Content-Length');
            let receivedLength = 0;
            let chunks = [];
            
            while(true) {
                const {done, value} = await reader.read();
                if (done) break;
                chunks.push(value);
                receivedLength += value.length;
                if (contentLength) document.getElementById('progressFill').style.width = (receivedLength / contentLength * 100) + "%";
            }
            
            document.getElementById('loadingText').innerText = "è§£æçµæ§‹ä¸­...";
            let text = new TextDecoder("utf-8").decode(concatUint8Arrays(chunks));
            parseBibleText(text);
            
            document.getElementById('loadingArea').style.display = 'none';
            document.getElementById('controlGrid').className += ' active';
            
            initSelectors();

            // *** è‡ªå‹•åŒ–æ ¸å¿ƒ ***
            checkUrlParams();
            
        } catch (e) {
            document.getElementById('loadingText').innerText = "Error: " + e.message;
        }
    }

    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const bookParam = params.get('book'); 
        const chapParam = params.get('chap');
        const startParam = params.get('start');
        const endParam = params.get('end');
        const autoParam = params.get('auto');

        if (bookParam && chapParam && bibleData[bookParam]) {
            bookSel.value = bookParam;
            updateChapters();
            
            if (bibleData[bookParam][chapParam]) {
                chapSel.value = chapParam;
                updateStartVerses();
                
                if (startParam) {
                    if (startParam === 'all' || bibleData[bookParam][chapParam][startParam]) {
                        startVerSel.value = startParam;
                        updateEndVerses();
                        if (endParam && endParam !== 'null' && bibleData[bookParam][chapParam][endParam]) {
                            endVerSel.value = endParam;
                        }
                    }
                }
                
                displayScripture();

                if (autoParam === 'gemini') {
                    // è‡ªå‹•åŸ·è¡Œè§£ç¶“ï¼Œä¸éœ€è¦ä½¿ç”¨è€…å†æŒ‰
                    document.getElementById('resultCard').scrollIntoView({ behavior: 'smooth' });
                    // é¡¯ç¤ºæŒ‰éˆ•æ­£åœ¨é‹ä½œçš„è¦–è¦ºæ•ˆæœ
                    const btn = document.getElementById('geminiBtn');
                    btn.innerText = "âœ¨ æ­£åœ¨å•Ÿå‹• AI...";
                    btn.style.opacity = "0.7";
                    
                    setTimeout(() => {
                        callGeminiAPI();
                        btn.innerText = "âœ¨ Gemini æ™ºèƒ½è§£ç¶“";
                        btn.style.opacity = "1";
                    }, 800);
                }
            }
        }
    }

    // è¼”åŠ©å‡½å¼ç¶­æŒä¸è®Š
    function concatUint8Arrays(arrays) {
        let totalLength = arrays.reduce((acc, val) => acc + val.length, 0);
        let result = new Uint8Array(totalLength);
        let len = 0;
        for (let arr of arrays) { result.set(arr, len); len += arr.length; }
        return result;
    }

    function parseBibleText(rawText) {
        const lines = rawText.split('\n');
        const lineRegex = /^(.+?)\s+(\d+):(\d+)\s+(.*)$/;
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            const match = line.match(lineRegex);
            if (match) {
                const book = match[1];
                const chapter = parseInt(match[2]);
                const verse = parseInt(match[3]);
                const content = match[4];
                if (!bibleData[book]) { bibleData[book] = {}; bookOrder.push(book); }
                if (!bibleData[book][chapter]) { bibleData[book][chapter] = {}; }
                bibleData[book][chapter][verse] = content;
            }
        });
    }

    const bookSel = document.getElementById('bookSelect');
    const chapSel = document.getElementById('chapterSelect');
    const startVerSel = document.getElementById('startVerseSelect');
    const endVerSel = document.getElementById('endVerseSelect');

    function initSelectors() {
        bookSel.innerHTML = "";
        bookOrder.forEach(bk => {
            let op = document.createElement('option');
            op.value = bk; op.text = bk; bookSel.add(op);
        });
        updateChapters();
    }

    function updateChapters() {
        const book = bookSel.value;
        chapSel.innerHTML = "";
        const chaps = Object.keys(bibleData[book]).map(Number).sort((a,b)=>a-b);
        chaps.forEach(ch => {
            let op = document.createElement('option');
            op.value = ch; op.text = `ç¬¬ ${ch} ç« `; chapSel.add(op);
        });
        updateStartVerses();
    }

    function updateStartVerses() {
        const book = bookSel.value;
        const chap = chapSel.value;
        startVerSel.innerHTML = `<option value="all">æ•´ç«  (Whole Chapter)</option>`;
        if (bibleData[book] && bibleData[book][chap]) {
            const verses = Object.keys(bibleData[book][chap]).map(Number).sort((a,b)=>a-b);
            verses.forEach(v => {
                let op = document.createElement('option');
                op.value = v; op.text = `ç¬¬ ${v} ç¯€`; startVerSel.add(op);
            });
        }
        updateEndVerses();
    }

    function updateEndVerses() {
        const startVal = startVerSel.value;
        if (startVal === "all") {
            document.getElementById('toLabel').style.display = "none";
            endVerSel.style.display = "none";
            return;
        }
        document.getElementById('toLabel').style.display = "block";
        endVerSel.style.display = "block";
        endVerSel.innerHTML = "";
        const book = bookSel.value;
        const chap = chapSel.value;
        const startNum = parseInt(startVal);
        if (bibleData[book] && bibleData[book][chap]) {
            const verses = Object.keys(bibleData[book][chap]).map(Number).sort((a,b)=>a-b);
            verses.forEach(v => {
                if (v >= startNum) {
                    let op = document.createElement('option');
                    op.value = v; op.text = `ç¬¬ ${v} ç¯€`; endVerSel.add(op);
                }
            });
        }
    }

    function nextChapter() {
        const currentBook = bookSel.value;
        const currentChap = parseInt(chapSel.value);
        if (bibleData[currentBook][currentChap + 1]) {
            chapSel.value = currentChap + 1;
        } else {
            const bookIdx = bookOrder.indexOf(currentBook);
            if (bookIdx < bookOrder.length - 1) {
                bookSel.value = bookOrder[bookIdx + 1];
                updateChapters();
                chapSel.value = 1;
            } else { return; }
        }
        updateStartVerses(); displayScripture();
    }

    function prevChapter() {
        const currentBook = bookSel.value;
        const currentChap = parseInt(chapSel.value);
        if (currentChap > 1) {
            chapSel.value = currentChap - 1;
        } else {
            const bookIdx = bookOrder.indexOf(currentBook);
            if (bookIdx > 0) {
                bookSel.value = bookOrder[bookIdx - 1];
                updateChapters();
                const chaps = Object.keys(bibleData[bookOrder[bookIdx - 1]]).map(Number);
                chapSel.value = Math.max(...chaps);
            } else { return; }
        }
        updateStartVerses(); displayScripture();
    }

    function displayScripture() {
        document.getElementById('geminiSection').style.display = 'none';
        document.getElementById('geminiResult').innerHTML = '';
        
        const book = bookSel.value;
        const chap = chapSel.value;
        const startVer = startVerSel.value;
        let displayText = "";
        let refText = "";
        const contextBtn = document.getElementById('contextBtn');
        
        if (startVer === "all") {
            refText = `${book} ç¬¬ ${chap} ç« `;
            const verses = bibleData[book][chap];
            Object.keys(verses).map(Number).sort((a,b)=>a-b).forEach(v => {
                displayText += `<span class='verse-num'>[${v}]</span>${verses[v]}\n`;
            });
            contextBtn.style.display = "none";
        } else {
            const startNum = parseInt(startVer);
            const endNum = parseInt(endVerSel.value);
            if (startNum === endNum) {
                 refText = `${book} ç¬¬ ${chap} ç«  ç¬¬ ${startNum} ç¯€`;
            } else {
                 refText = `${book} ç¬¬ ${chap} ç«  ç¬¬ ${startNum}-${endNum} ç¯€`;
            }
            for (let i = startNum; i <= endNum; i++) {
                if (bibleData[book][chap][i]) {
                    displayText += `<span class='verse-num'>[${i}]</span>${bibleData[book][chap][i]}\n`;
                }
            }
            contextBtn.style.display = "block";
        }

        document.getElementById('resultCard').style.display = 'block';
        document.getElementById('displayRef').innerText = refText;
        document.getElementById('displayText').innerHTML = displayText;
        
        generateHiddenPrompt(refText);
    }

    function switchToWholeChapter() {
        startVerSel.value = 'all';
        updateEndVerses();
        displayScripture();
    }

    function generateHiddenPrompt(ref) {
        const prompt = `è«‹ç”¨ä¸­æ–‡ï¼ˆç¹é«”ï¼‰ä¸¦ä»¥æ­£çµ±åŸºç£æ•™ä¿¡ä»°å’Œè–ç¶“çœŸç†ç‚ºåŸºç¤ï¼Œè§£é‡‹è–ç¶“ã€${ref}ã€‘ã€‚

è«‹æä¾›ï¼š
- ã€ç¶“æ–‡æ¦‚è¦ã€‘æ¦‚è¿°æ­¤ç« å…§å®¹èˆ‡ä¸»è¦äº‹ä»¶ã€‚
- ã€ç¶“æ–‡è§£é‡‹ã€‘è©³ç´°é—¡è¿°è©²ç¯€çš„å«ç¾©ã€‚
- ã€å±¬éˆæ‡‰ç”¨ã€‘æä¾›å¦‚ä½•å°‡æ­¤ç« çš„ä¿¡æ¯æ‡‰ç”¨æ–¼ä¿¡å¾’ç”Ÿæ´»ã€‚`;
        document.getElementById('hiddenPrompt').value = prompt;
    }

    async function callGeminiAPI() {
        const prompt = document.getElementById('hiddenPrompt').value;
        
        const section = document.getElementById('geminiSection');
        const loading = document.getElementById('aiLoading');
        const result = document.getElementById('geminiResult');
        
        section.style.display = 'block';
        loading.style.display = 'block';
        result.innerHTML = '';
        section.scrollIntoView({ behavior: 'smooth' });

        try {
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const rawMarkdown = data.candidates[0].content.parts[0].text;
            result.innerHTML = parseMarkdown(rawMarkdown);
        } catch (error) {
            result.innerHTML = `<span style="color:red; font-weight:bold;">ç„¡æ³•è§£è®€: ${error.message}</span>`;
        } finally {
            loading.style.display = 'none';
        }
    }

    function parseMarkdown(text) {
        let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
        html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
        html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
        html = html.replace(/\n{3,}/g, '\n\n');
        html = html.replace(/(<\/h[1-3]>)\n+/g, '$1');
        html = html.replace(/\n/g, '<br>');
        return html;
    }
</script>

</body>
</html>
